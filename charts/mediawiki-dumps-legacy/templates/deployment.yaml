---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "base.name.chart" . }}-toolbox
  {{- include "base.meta.labels" . | indent 2 }}
    component: toolbox
spec:
  selector:
  {{- include "base.meta.selector" . | indent 4 }}
  replicas: 1
  template:
    metadata:
      labels:
        component: toolbox
        {{/* We hardcode these labels so that the toolbox pod is matched by the mediawiki networkpolicy selector */}}
        app: mediawiki
        release: production
    spec:
      securityContext:
        fsGroup: {{ $.Values.dumps.toolbox.fs_group }}
      containers:
      - name: "toolbox"
        command: ["sleep"]
        args: ["infinity"]
        image: "{{ .Values.docker.registry }}/{{ .Values.main_app.image }}"
        imagePullPolicy: {{ .Values.docker.pull_policy }}
        {{- include "base.helper.restrictedSecurityContext" . | nindent 8 }}
        {{ include "base.helper.resources" $.Values.dumps.toolbox.resources | indent 8 }}
        volumeMounts:
        - name: dumps-cephfs
          mountPath: {{ $.Values.dumps.persistence.mount_path }}
        - name: mediwiki-dumps-legacy-configs
          mountPath: /etc/dumps/confs
        - name: mediwiki-dumps-legacy-templates
          mountPath: /etc/dumps/templs
        - name: mediwiki-dumps-legacy-dblists
          mountPath: /etc/dumps/dblists
        env:
        - name: SERVERGROUP
          value: kube-dumps
      volumes:
      - name: dumps-cephfs
        persistentVolumeClaim:
          claimName: {{ $.Values.dumps.persistence.claim_name }}
      - name: mediwiki-dumps-legacy-configs
        configMap:
          name: mediwiki-dumps-legacy-configs
      - name: mediwiki-dumps-legacy-templates
        configMap:
          name: mediwiki-dumps-legacy-templates
      - name: mediwiki-dumps-legacy-dblists
        configMap:
          name: mediwiki-dumps-legacy-dblists
