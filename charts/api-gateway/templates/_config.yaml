{{- define "config.app" }}

# api gateway envoy config
{{ if .Values.main_app.telemetry_port -}}
admin:
  access_log_path: /dev/stdout
  address:
    socket_address:
      protocol: TCP
      address: 127.0.0.1
      port_value: 1666
{{ end -}}
static_resources:
  listeners:
{{- if .Values.main_app.telemetry_port }}
  - name: telemetry_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: {{ .Values.main_app.telemetry_port }}
    filter_chains:
    - filters:
      - name: envoy.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          http_filters:
          - name: envoy.health_check
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
              pass_through_mode: false
              headers:
                - name: ":path"
                  exact_match: "/healthz"
          - name: envoy.filters.http.router
            typed_config: {}
          http_protocol_options: {accept_http_10: true}
          route_config:
            virtual_hosts:
            - domains: ['*']
              name: admin_cluster
              routes:
              - match:
                  prefix: /stats
                route:
                  cluster: admin_cluster
                  prefix_rewrite: "/stats"
                  timeout: 5.0s
              - match:
                  prefix: /
                direct_response:
                  status: 403
                  body: {inline_string: "You can't access this url."}
          stat_prefix: admin_cluster
{{- end }}
  - name: listener_0
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: {{ .Values.app.port }}
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
{{- if .Values.main_app.access_log }}
          # configure logging
          access_log:
            name: envoy.file_access_log
            filter:
              not_health_check_filter: {}
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
{{- if eq .Values.main_app.access_log.type "stdout" }}
              path: /dev/stdout
{{- else if eq .Values.main_app.access_log.type "eventgate" }}
              path: /var/log/access.log
{{- else }}
{{ fail "Invalid access_log.type" }}
{{- end }}
              log_format:
                omit_empty_values: true
                json_format:
                  $schema: "/api-gateway/request/1.0.0"
                  meta:
                    uri: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                    request_id: "%REQ(X-REQUEST-ID)%"
                    dt: "%START_TIME(%FT%TZ)%"
                    domain: "%REQ(HOST)%"
                    stream: "api-gateway.request"
                  http:
                    method: "%REQ(:METHOD)%"
                    protocol: "%PROTOCOL%"
                    status_code: "%RESPONSE_CODE%"
                    client_ip: "%REQ(X-FORWARDED-FOR)%"
                    request_headers:
                      user-agent: "%REQ(USER-AGENT)%"
                  total_time_ms: "%DURATION%"
                  client_id: "%DYNAMIC_METADATA(envoy.filters.http.jwt_authn:jwt_payload:aud)%"
                  route: "%ROUTE_NAME%"
{{- end }}
          use_remote_address: true
          local_reply_config:
            # Override the empty %LOCAL_REPLY_BODY% for 404 to "Not Found"
            mappers:
              - filter:
                  status_code_filter:
                    comparison:
                      op: EQ
                      value:
                        default_value: 404
                        runtime_key: unused_key_404
                body:
                  inline_string: "Not Found"
            # Default format applied to all error responses
            body_format:
              json_format:
                httpCode: "%RESPONSE_CODE%"
                httpReason: "%LOCAL_REPLY_BODY%"
          route_config:
{{ include "apigateway.routes" . }}
          http_filters:
          - name: envoy.health_check
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
              pass_through_mode: false
              headers:
                - name: ":path"
                  exact_match: "/healthz"
          - name: envoy.filters.http.cors
{{- if .Values.main_app.jwt.enabled }}
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                wikimedia:
                  issuer: {{ .Values.main_app.jwt.issuer }}
                  local_jwks:
                    filename: /etc/jwks/jwks.json
                  forward: true
                  from_headers:
                    name: Authorization
                    value_prefix: Bearer
                  payload_in_metadata: "jwt_payload"
              rules:
{{ include "apigateway.ratelimit_rules" . }}
{{- end }}
{{- if .Values.main_app.ratelimiter }}
          - name: envoy.filters.http.ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
              domain: wikimedia
              stage: 0
              timeout: 0.25s
              enable_x_ratelimit_headers: DRAFT_VERSION_03
              rate_limit_service:
                transport_api_version: V3
                grpc_service:
                  envoy_grpc:
                    cluster_name: rate_limit_cluster
{{- end }}
          - name: envoy.filters.http.header_to_metadata
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config
              request_rules:
                - header: "x-wikimedia-debug"
                  on_header_present:
                    metadata_namespace: envoy.lb
                    key: x_wikimedia_debug_server
                    regex_value_rewrite:
                      pattern:
                        google_re2: {}
                        regex: "^backend=([\\w.]+).*$"
                      substitution: "\\1"
                  on_header_missing:
                    metadata_namespace: envoy.lb
                    key: x_wikimedia_debug_server
                    value: none
                    type: STRING
          - name: envoy.filters.http.router
{{- if .Values.mesh.enabled }}
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
              certificate_chain:
                filename: "/etc/envoy-ssl/service.crt"
              private_key:
                filename: "/etc/envoy-ssl/service.key"
{{- end }}
  clusters:
{{- $idle_timeout := .Values.main_app.idle_timeout -}}
{{- /* BEGIN endpoints cluster definition */}}
{{- range $cluster_name, $cluster_opts := .Values.main_app.endpoints }}
{{ if $cluster_opts }}
  - name: {{ $cluster_name }}
    connect_timeout: 0.25s
    max_requests_per_connection: 1000
    common_http_protocol_options:
      idle_timeout: {{ $idle_timeout }}
    type: {{ $cluster_opts.type }}
    lb_policy: ROUND_ROBIN
    # required for non-ipv6 services on localhost or elsewhere
    dns_lookup_family: V4_ONLY
{{- if $cluster_opts.tls }}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            cipher_suites: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
          validation_context:
            trusted_ca:
              filename: /etc/ssl/certs/wmf-ca-certificates.crt
{{- end }}
    lb_subset_config:
      fallback_policy: "DEFAULT_SUBSET"
      default_subset:
        x_wikimedia_debug_server: none
      subset_selectors:
        - keys:
            - x_wikimedia_debug_server
    load_assignment:
      cluster_name: {{ $cluster_name }}
      endpoints:
      - lb_endpoints:
{{- range $host, $port := $cluster_opts.hosts }}
        - endpoint:
            address:
              socket_address:
                address: {{ $host }}
                port_value: {{ $port }}
          metadata:
            filter_metadata:
              envoy.lb:
                x_wikimedia_debug_server: none
{{- end }}
{{- range $host, $port := $cluster_opts.debug_hosts }}
        - endpoint:
            address:
              socket_address:
                address: {{ $host }}
                port_value: {{ $port }}
          metadata:
            filter_metadata:
              envoy.lb:
                x_wikimedia_debug_server: {{ $host }}
{{- end }}
{{- end }}
{{- end }}
{{- /* END endpoints cluster definition */}}
{{- /* BEGIN staging cluster definition */}}
{{- if eq .Release.Name "staging" }}
{{- if .Values.main_app.staging_endpoints }}
{{- range $cluster_name, $cluster_opts := .Values.main_app.staging_endpoints }}
  - name: {{ $cluster_name }}_cluster
    connect_timeout: 0.25s
    max_requests_per_connection: 1000
    common_http_protocol_options:
      idle_timeout: {{ $idle_timeout }}
    type: LOGICAL_DNS
    lb_policy: ROUND_ROBIN
    # required for non-ipv6 services on localhost or elsewhere
    dns_lookup_family: V4_ONLY
{{- if $cluster_opts.tls }}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            cipher_suites: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
          validation_context:
            trusted_ca:
              filename: /etc/ssl/certs/wmf-ca-certificates.crt
{{- end }}
    load_assignment:
      cluster_name: {{ $cluster_name }}_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: {{ $cluster_name }}
                port_value: {{ $cluster_opts.port }}
{{- end }}
{{- end }}
{{- end }}
{{- /* END staging cluster definition */}}
{{- /* BEGIN discovery cluster definition */}}
{{- range $cluster_name, $cluster_opts := .Values.main_app.discovery_endpoints }}
  - name: {{ $cluster_name }}_cluster
    connect_timeout: 0.25s
    max_requests_per_connection: 1000
    common_http_protocol_options:
      idle_timeout: {{ $idle_timeout }}
    type: LOGICAL_DNS
    lb_policy: ROUND_ROBIN
    # required for non-ipv6 services on localhost or elsewhere
    dns_lookup_family: V4_ONLY
{{- if $cluster_opts.tls }}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            cipher_suites: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
          validation_context:
            trusted_ca:
              filename: /etc/ssl/certs/wmf-ca-certificates.crt
{{- end }}
    load_assignment:
      cluster_name: {{ $cluster_name }}_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: {{ $cluster_opts.internal_host | default (list $cluster_name "discovery.wmnet" | join ".") }}
                port_value: {{ $cluster_opts.port }}
{{- end }}
{{- /* END discovery cluster definition */}}
{{- if .Values.main_app.ratelimiter }}
  - name: rate_limit_cluster
    type: static
    connect_timeout: 0.25s
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: rate_limit_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 8081
{{- end }}
{{ if .Values.main_app.telemetry_port }}
  - name: admin_cluster
    type: static
    connect_timeout: 0.25s
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: admin_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 1666
{{- end }}
{{- end }}
