apiVersion: crd.projectcalico.org/v1
kind: NetworkPolicy
metadata:
  name: {{ include "cluster.fullname" . }}-to-kubapi
spec:
  types:
    - Egress
  selector: "cnpg.io/jobRole in { 'initdb', 'join' } || cnpg.io/podRole in { 'instance', 'pooler' }"
  egress:
    - action: Allow
      destination:
        services:
          name: kubernetes
          namespace: default
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "cluster.fullname" . }}-ingress-pooler
spec:
  podSelector:
    matchLabels:
      cnpg.io/podRole: pooler
  policyTypes:
    - Ingress
  ingress:
    - ports:
      - port: 5432
        protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "cluster.fullname" . }}-ingress-instance
spec:
  podSelector:
    matchLabels:
      cnpg.io/podRole: instance
  policyTypes:
    - Ingress
  ingress:
    - ports:
      - port: 8000 {{/* API port */}}
        protocol: TCP
