# NOTE: values-staging.yaml is configured to be deployed in staging-eqiad.
# It uses Kafka test-eqiad, Zookeeper test-eqiad, and thanos swift in eqiad.
#
# The Zookeeper HA and checkpoint path naming convention uses 'staging'
# as the k8s cluster name, as SRE ServiceOps has recommended to us to (for now)
# assume that staging-codfw does not exist, and not refer to staging-eqiad anywhere.

app:
  config_files:
    app.config.yaml:

      # Configs for eventutilities python stream_manager.
      stream_manager:
        # Configure sources and sinks.
        source:
          options:
            bootstrap_servers: kafka-test1006.eqiad.wmnet:9093,kafka-test1007.eqiad.wmnet:9093,kafka-test1008.eqiad.wmnet:9093,kafka-test1009.eqiad.wmnet:9093,kafka-test1010.eqiad.wmnet:9093
            # Kafka consumer group naming follows convention: <job_name>__<k8s_cluster_name>
            consumer_group: mw_page_content_change_enrich__wikikube-staging_000

        sink:
          options:
            bootstrap_servers: kafka-test1006.eqiad.wmnet:9093,kafka-test1007.eqiad.wmnet:9093,kafka-test1008.eqiad.wmnet:9093,kafka-test1009.eqiad.wmnet:9093,kafka-test1010.eqiad.wmnet:9093
            kafka_topic_prefix: eqiad.


  flinkConfiguration:
    # Directory naming follows s3://<job_name>__<k8s_cluster_name> convention.
    "state.checkpoints.dir": s3://mw_page_content_change_enrich__wikikube-staging/checkpoints # needed for upgradeMode: savepoint
    "state.savepoints.dir": s3://mw_page_content_change_enrich__wikikube-staging/savepoints # needed for upgradeMode: savepoint


# TODO: when deploying to eqiad + codfw, we'll need to set
# higher resource limits for taskmanagers.
# See helmfile.d/dse-k8s-services/values-dse-k8s-eqiad.yaml.

# NOTE: staging uses Kafka test-eqiad cluster for both source and sink.
# Because kafka test-eqiad doesn't have real mediawiki.page_change
# traffic, it won't really be doing any work.
kafka:
  allowed_clusters: [test-eqiad]

networkpolicy:
  egress:
    dst_nets:

      # thanos-swift cluster in eqiad for checkpoints
      - cidr: 10.2.2.54/32   # thanos-swift.svc.eqiad.wmnet
        ports:
          - port: 443
            protocol: tcp
