service:
  deployment: production
  # HTTP port 30892 in chart values.yaml
  routing_tag: eventstreams

tls:
  enabled: true
  # HTTPS port 4892 in chart values.yaml
  telemetry:
    enabled: true

resources:
  replicas: 8

main_app:
  name: eventstreams
  version: 2020-03-23-173308-production

  requests:
    cpu: 200m
    memory: 500Mi
  limits:
    cpu: 1500m
    memory: 1000Mi

  conf:
    kafka:
      metadata.broker.list: kafka-main2001.codfw.wmnet:9093,kafka-main2002.codfw.wmnet:9093,kafka-main2003.codfw.wmnet:9093
      queued.max.messages.kbytes: 32768
      fetch.message.max.bytes: 8388608
      queued.min.messages: 1000
      statistics.interval.ms: 60000
      # Enable Kafka consumer TLS (no authentication, just encryption).
      security.protocol: ssl

    # List of stream name (routes) and their constituent topics.
    # This is used to choose which topics are exposed, as well as for
    # generating the OpenAPI spec documentation.
    streams:

      test:
        description: |-
          A test event stream. A new event is posted about once a minute.
          Schema: https://github.com/wikimedia/mediawiki-event-schemas/tree/master/jsonschema/test/event
        topics:
          - eqiad.test.event
          - codfw.test.event

      page-create:
        description: |-
          Mediawiki Page create events. This page create stream is just the first revision create
          event for each page. As such, it reuses the mediawiki/revision/create schema.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/revision/create/latest
        topics:
          - eqiad.mediawiki.page-create
          - codfw.mediawiki.page-create

      page-delete:
        description: |-
          Mediawiki Page delete events.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/page/delete/latest
        topics:
          - eqiad.mediawiki.page-delete
          - codfw.mediawiki.page-delete

      page-move:
        description: |-
          Mediawiki Page move (rename) events.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/page/move/latest
        topics:
          - eqiad.mediawiki.page-move
          - codfw.mediawiki.page-move

      page-undelete:
        description: |-
          Mediawiki Page un-delete events.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/page/undelete/latest
        topics:
          - eqiad.mediawiki.page-undelete
          - codfw.mediawiki.page-undelete

      page-properties-change:
        description: |-
          Mediawiki Page Properties change events.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/page/properties-change/latest
        topics:
          - eqiad.mediawiki.page-properties-change
          - codfw.mediawiki.page-properties-change

      page-links-change:
        description: |-
          Mediawiki Page Links change events.
          Schema: https://schema.wikimedia.org/repositories/primary/jsonschema/mediawiki/page/links-change/latest
        topics:
          - eqiad.mediawiki.page-links-change
          - codfw.mediawiki.page-links-change

      recentchange:
        description: |-
          Mediawiki RecentChanges feed.
          Schema: https://github.com/wikimedia/mediawiki-event-schemas/tree/master/jsonschema/mediawiki/recentchange
        topics:
          - eqiad.mediawiki.recentchange
          - codfw.mediawiki.recentchange

      revision-create:
        description: |-
          Mediawiki Revision create events.
          Schema: https://github.com/wikimedia/mediawiki-event-schemas/tree/master/jsonschema/mediawiki/revision/create
        topics:
          - eqiad.mediawiki.revision-create
          - codfw.mediawiki.revision-create

      revision-score:
        description: |-
          Mediawiki Revision Score feed. Every new revision in an ORES enabled wiki should have a
          revision-score event. This schema is structured differnetly than ORES API results, as
          event schemas should map well into RDBMS / SQL environments where columns must be
          strongly typed.
          NOTE: Only the most commonly used ORES model scores are included in each event
          (the ones returned by https://ores.wikimedia.org/v3/precache).
          Schema: https://github.com/wikimedia/mediawiki-event-schemas/tree/master/jsonschema/mediawiki/revision/score
        topics:
          - eqiad.mediawiki.revision-score
          - codfw.mediawiki.revision-score
networkpolicy:
  egress:
    enabled: false
    dst_nets:
    - cidr: 10.64.0.11/32 # kafka1001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.16.41/32 # kafka1002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.32.127/32 # kafka1003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:101:10:64:0:11/128 # kafka1001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:102:10:64:16:41/128 # kafka1002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:103:10:64:32:127/128 # kafka1003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
      # codfw:
    - cidr: 10.192.0.139/32 # kafka2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.16.169/32 # kafka2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.32.150/32 # kafka2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.0.200/32 # kafka-main1001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.16.37/32 # kafka-main1002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.32.90/32 # kafka-main1003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.48.30/32 # kafka-main1004
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.48.31/32 # kafka-main1005
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.0.17/32 # kafka-main2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.16.8/32 # kafka-main2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.32.136/32 # kafka-main2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.48.38/32 # kafka-main2004
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.48.46/32 # kafka-main2005
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:101:10:192:0:139/128 # kafka2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:102:10:192:16:169/128 # kafka2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:103:10:192:32:150/128 # kafka2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:101:10:64:0:200/128 # kafka-main1001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:102:10:64:16:37/128 # kafka-main1002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:103:10:64:32:90/128 # kafka-main1003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:107:10:64:48:30/128 # kafka-main1004
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:107:10:64:48:31/128 # kafka-main1005
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:101:10:192:0:17/128 # kafka-main2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:102:10:192:16:8/128 # kafka-main2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:103:10:192:32:136/128 # kafka-main2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:104:10:192:48:38/128 # kafka-main2004
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:104:10:192:48:46/128 # kafka-main2005
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
