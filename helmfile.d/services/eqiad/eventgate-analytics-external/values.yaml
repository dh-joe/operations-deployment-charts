service:
  deployment: production
  port: 36192
  routing_tag: eventgate-analytics-external

tls:
  enabled: true
  image_version: 1.13.1-1
  public_port: 4692 # the port where TLS will be exposed

resources:
  replicas: 3

main_app:
  name: eventgate-analytics-external
  version: 2020-04-20-182143-production
  conf:
    kafka:
      conf:
        metadata.broker.list: kafka-jumbo1001.eqiad.wmnet:9093,kafka-jumbo1002.eqiad.wmnet:9093,kafka-jumbo1003.eqiad.wmnet:9093,kafka-jumbo1004.eqiad.wmnet:9093,kafka-jumbo1005.eqiad.wmnet:9093,kafka-jumbo1006.eqiad.wmnet:9093
        # Enforce a smaller message size limit for this externally accessible eventgate instance.
        message.max.bytes: 1048576
        # Enable Kafka producer TLS (no authentication, just encryption).
        security.protocol: ssl
    schema_precache_uris:
    - /error/0.0.3
    - /test/event/0.0.3
    topic_prefix: eqiad.

    # /srv/service/schemas/event/{primary,secondary} is in the eventgate-wikmiedia image cloned at
    # image build time from https://gerrit.wikimedia.org/r/schemas/event/{primary,secondary}
    # http://schema.discovery.wmnet hosts a more up to date clone of the secondary (and other)
    # event schema repositories. These will all be used when looking up schemas.
    # By also using a remote schema URI, eventgate can discover new schemas without rebuilding the
    # image.
    schema_base_uris:
    - 'file:///srv/service/schemas/event/primary/jsonschema/'
    - 'file:///srv/service/schemas/event/secondary/jsonschema/'
    - 'https://schema.discovery.wmnet/repositories/secondary/jsonschema/'

    # Request dynamic stream config from the EventStreamConfig extension MW API endpoint.
    # We use meta.wikimedia.org here as the default stream configuration wiki.
    # Streams can be configured per wiki in mediawiki-config, but they should always be at
    # least configured with a stream name and schema_title available from meta.wikimedia.org.
    # NOTE: Request config from MW internal api.svc and set Host to meta.wikimedia.org.
    # NOTE: we need all_settings, otherwise we will not receive the stream's schema_title, which
    # is what EventGate needs to verify that an event of a given schema is allowed in a stream.
    stream_config_uri: 'http://api.svc.eqiad.wmnet/w/api.php?format=json&action=streamconfigs&all_settings=true&streams=<%= stream %>'
    stream_config_uri_options: {'headers': {'Host': 'meta.wikimedia.org'}}    # Re-request for yet unknown streams at runtime
    stream_config_is_dynamic: true
    # Expect the stream -> settings map in the response at this subobject key
    stream_config_object_path: streams
    # Expire and re-request dynamic stream configs every 5 minutes
    stream_config_ttl: 300
    stream_config_recache_on_expire: true
