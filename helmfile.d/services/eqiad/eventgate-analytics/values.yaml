service:
  deployment: production
  port: 35192
  routing_tag: eventgate-analytics

tls:
  enabled: true
  public_port: 4592 # the port where TLS will be exposed

resources:
  replicas: 20

main_app:
  name: eventgate-analytics
  version: 2020-07-07-130941-production
  conf:
    kafka:
      conf:
        metadata.broker.list: kafka-jumbo1001.eqiad.wmnet:9093,kafka-jumbo1002.eqiad.wmnet:9093,kafka-jumbo1003.eqiad.wmnet:9093,kafka-jumbo1004.eqiad.wmnet:9093,kafka-jumbo1005.eqiad.wmnet:9093,kafka-jumbo1006.eqiad.wmnet:9093,kafka-jumbo1007.eqiad.wmnet:9093,kafka-jumbo1008.eqiad.wmnet:9093,kafka-jumbo1009.eqiad.wmnet:9093
        security.protocol: ssl
    schema_precache_uris:
    - /error/0.0.3
    - /test/event/0.0.3
    - /mediawiki/api/request/0.0.1
    - /mediawiki/cirrussearch/request/0.0.1
    - /sparql/query/1.0.0
    topic_prefix: eqiad.

    # /srv/service/schemas/event/{primary,secondary} is in the eventgate-wikmiedia image cloned at
    # image build time from https://gerrit.wikimedia.org/r/schemas/event/{primary,secondary}
    # http://schema.discovery.wmnet hosts a more up to date clone of the secondary (and other)
    # event schema repositories. These will all be used when looking up schemas.
    # By also using a remote schema URI, eventgate can discover new schemas without rebuilding the
    # image.
    schema_base_uris:
    - 'file:///srv/service/schemas/event/primary/jsonschema/'
    - 'file:///srv/service/schemas/event/secondary/jsonschema/'
    - 'https://schema.discovery.wmnet/repositories/secondary/jsonschema/'
    # TODO: mediawiki schema repo is deprecated; use primary and secondary repos instead.
    # Will remove this after canary release is done to test this in a canary change.
    - 'file:///srv/service/schemas/mediawiki-event-schemas/jsonschema/'

  stream_config:
    mediawiki.api-request:
      schema_title: mediawiki/api/request
    mediawiki.cirrussearch-request:
      schema_title: mediawiki/cirrussearch/request
    wdqs-internal.sparql-query:
      schema_title: sparql/query
    wdqs-external.sparql-query:
      schema_title: sparql/query
    cqs-external.sparql-query:
      schema_title: sparql/query
    '/^swift\.(.+\.)?upload-complete$/':
      schema_title: swift/upload/complete
networkpolicy:
  egress:
    enabled: false
    dst_nets:
    - cidr: 10.64.0.175/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.0.176/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.16.99/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.32.159/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.32.160/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.48.117/32
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:101:10:64:0:175/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:101:10:64:0:176/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:102:10:64:16:99/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:103:10:64:32:159/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:103:10:64:32:160/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:107:10:64:48:117/128
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093

      # Allow schema.svc.{eqiad,codfw} for eventgate-analytics
    - cidr: 10.2.2.43/32 # schema.svc.eqiad.wmnet
      ports:
      - protocol: tcp
        port: 8190
    - cidr: 10.2.1.43/32 # schema.svc.codfw.wmnet
      ports:
      - protocol: tcp
        port: 8190
