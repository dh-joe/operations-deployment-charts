service:
  deployment: production
  port: 33192
  routing_tag: eventgate-logging-external
tls:
  enabled: true
  public_port: 4392 # the port where TLS will be exposed
  image_version: 1.14.4-1
main_app:
  name: eventgate-logging-external
  version: 2020-08-05-202508-production
  conf:
    # The request body is accepted as an array of events, each of which
    # will be an individual message in Kafka.  Each individual
    # message must be smaller than message.max.bytes, but EventGate
    # can accept multiple events at once in the request body.
    # Limit this to a smaller size for this externally accessible eventgate instance.
    max_body_size: 4mb
    kafka:
      conf:
        metadata.broker.list: logstash1010.eqiad.wmnet:9093,logstash1011.eqiad.wmnet:9093,logstash1012.eqiad.wmnet:9093
        # Enforce a smaller message size limit for this externally accessible eventgate instance.
        message.max.bytes: 1048576
        # Enable Kafka producer TLS (no authentication, just encryption).
        security.protocol: ssl
    schema_base_uris:
    - 'file:///srv/service/schemas/event/primary/jsonschema/'
    schema_precache_uris:
    - /error/1.0.0
    - /test/event/0.0.3
    - /mediawiki/client/error/1.0.0
    topic_prefix: staging.
    # Request static stream config during startup from the EventStreamConfig extension
    # MW API endpoint for all streams with destination_event_service == eventgate-logging-external.
    # We use meta.wikimedia.org here as the default stream configuration wiki.
    # Streams can be configured per wiki in mediawiki-config, but they should always be at
    # least configured with a stream name and schema_title available from meta.wikimedia.org.
    # NOTE: Request config from MW internal api.svc and set Host to meta.wikimedia.org.
    # NOTE: we need all_settings, otherwise we will not receive the stream's schema_title, which
    # is what EventGate needs to verify that an event of a given schema is allowed in a stream.
    stream_config_uri: 'http://api.svc.eqiad.wmnet/w/api.php?format=json&action=streamconfigs&all_settings=true&constraints=destination_event_service=eventgate-logging-external'
    stream_config_uri_options: {'headers': {'Host': 'meta.wikimedia.org'}}
    # Only request stream configs once at startup.
    stream_config_is_dynamic: false
    # Expect the stream -> settings map in the response at this subobject key
    stream_config_object_path: streams

networkpolicy:
  egress:
    enabled: false
    dst_nets:
    - cidr: 10.64.0.181/32 # logstash1010
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.16.30/32 # logstash1011
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.64.48.177/32 # logstash1012
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:101:10:64:0:181/128 # logstash1010
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:102:10:64:16:30/128 # logstash1011
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:861:107:10:64:48:177/128 # logstash1012
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.0.112/32 # logstash2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.32.180/32 # logstash2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 10.192.48.131/32 # logstash2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:101:10:192:0:112/128 # logstash2001
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:103:10:192:32:180/128 # logstash2002
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
    - cidr: 2620:0:860:104:10:192:48:131/128 # logstash2003
      ports:
      - protocol: tcp
        port: 9092
      - protocol: tcp
        port: 9093
