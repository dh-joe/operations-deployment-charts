docker:
  registry: docker-registry.discovery.wmnet
main_app:
  image: "restricted/mediawiki-multiversion:2021-07-01-232810-publish"
  requests:
    cpu: 1000m
    memory: 1000Mi
  limits:
    cpu: 2000m
    memory: 2000Mi

service:
  deployment: production
  port:
    nodePort: 4444
resources:
  replicas: 1

tls:
  enabled: false
  public_port: 4444
monitoring:
  enabled: true

debug:
  enabled: false
  ports: []

# See the dockerfiles for the the php-fpm base image to know what can be tweaked.
# Those can be passed via config.public above.
php:
  fcgi_mode: FCGI_TCP
  exporter_version: 0.0.2
  httpd:
    exporter_version: 0.0.3
  opcache:
    nofiles: "5000"
    size: "250"
mw:
  domain_suffix: "org"
  httpd:
    image_tag: "restricted/mediawiki-webserver:2021-04-19-173449-webserver"
  mcrouter:
    enabled: true
    image_tag: mcrouter:latest
    exporter_version: 0.0.1-2
    resources:
      requests:
        cpu: 200m
        memory: 100Mi
      limits:
        cpu: 1
        memory: 200Mi
    pools:
      - name: eqiad-servers
        zone: eqiad
        servers: &eqiad_servers
          - 10.64.0.80
          - 10.64.0.81
          - 10.64.0.82
          - 10.64.0.83
          - 10.64.0.84
          - 10.64.16.108
          - 10.64.0.125
          - 10.64.16.109
          - 10.64.0.124
          - 10.64.32.208
          - 10.64.32.209
          - 10.64.32.210
          - 10.64.32.211
          - 10.64.32.212
          - 10.64.48.155
          - 10.64.48.156
          - 10.64.48.157
          - 10.64.48.158
        failover:
          - 10.64.0.53
          - 10.64.32.101
          - 10.64.48.32
      - name: codfw-proxies
        zone: codfw
        servers:
          - 10.192.0.169
          - 10.192.16.57
          - 10.192.32.115
          - 10.192.48.95
        failover:
          - 10.192.48.95
          - 10.192.32.115
          - 10.192.16.57
          - 10.192.0.169
  #TODO: add the codfw servers and the eqiad proxies
  nutcracker:
    enabled: true
    image_tag: nutcracker:0.0.4
    exporter_version: 0.0.2
    resources:
      requests:
        cpu: 200m
        memory: 100Mi

discovery:
  listeners:
    - parsoid-php
    - mathoid
    - eventgate-analytics
    - eventgate-analytics-external
    - eventgate-main
    - sessionstore
    - echostore
    - termbox
    - push-notifications
    - wdqs-internal
    - ores
    - restbase
    - cxserver
    - swift-eqiad
    - swift-codfw
    - search-chi-eqiad
    - search-chi-codfw
    - search-omega-eqiad
    - search-omega-codfw
    - search-psi-eqiad
    - search-psi-codfw
    - cloudelastic-chi-eqiad
    - cloudelastic-omega-eqiad
    - cloudelastic-psi-eqiad

# network egress for various services
networkpolicy:
  egress:
    enabled: true
    dst_nets:
      # swift is covered by envoy even if still not used in mediawiki.
      # url-downloader is covered by the default egress rules
      # redis_lock is covered by the nutcracker-originated rules for redis
      # Common defs
      #IRC - TODO: define the port range once we upgrade k8s
      # irc1001
      - cidr: 208.80.155.105/32
      # irc2001
      - cidr: 208.80.153.62/32
      # xenon
      # mwlog1002
      - cidr: 10.64.32.141/32
        ports:
          - protocol: TCP
            port: 6379
      # statsd
      # graphite1004 / statsd.eqiad.wmnet
      - cidr: 10.64.16.149/32
        ports:
          - protocol: UDP
            port: 9125
      # eventlogging
      # eventlog1001
      - cidr: 10.64.32.167/32
        ports:
          - protocol: TCP
            port: 8421
      # logstash
      # logstash.svc.eqiad.wmnet
      - cidr: 10.2.2.36/32
      # DC-specific defs
      ## Eqiad
      # Poolcounter
      # poolcounter1004
      - cidr: 10.64.0.151/32
        ports:
          - protocol: TCP
            port: 7531
      # poolcounter1005
      - cidr: 10.64.32.236/32
        ports:
          - protocol: TCP
            port: 7531
      # udp2log
      # mwlog1002
      - cidr: 10.64.32.141/32
        ports:
          - protocol: UDP
            port: 8420

      ## Codfw
      # Poolcounter
      # poolcounter2003
      - cidr: 10.192.0.132/32
        ports:
          - protocol: TCP
            port: 7531
      # poolcounter2004
      - cidr: 10.192.16.129/32
        ports:
          - protocol: TCP
            port: 7531
      # udp2log
      # mwlog2002
      - cidr: 10.192.32.9/32
        ports:
          - protocol: UDP
            port: 8420
