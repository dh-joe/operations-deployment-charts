docker:
  registry: docker-registry.discovery.wmnet
resources:
  replicas: 76
main_app:
  image: wikimedia/mediawiki-services-mobileapps
  version: 2024-06-17-121748-production
  # Use the service proxy to connect to MediaWiki and restbase
  mwapi_uri: http://localhost:6500/w/api.php
  mwrestapi_uri: http://localhost:6500/w/rest.php
  restbase_uri: http://localhost:6503
  mw_resource_loader_uri: http://localhost:6500/w/load.php
  limits:
    cpu: 2
  use_coreparsoid_endpoint: true

monitoring:
  enabled: true
service:
  deployment: production
  port:
    nodePort: 8888
mesh:
  enabled: true
  public_port: 4102
  local_access_log_min_code: 100

discovery:
  listeners:
  - mw-api-int-async   # TODO: change to a more stringent timeout
  - restbase-for-services
  - eventgate-main

networkpolicy:
  egress:
    enabled: true
    dst_nets:
    # Allow api
    - cidr: 10.2.2.22/32
      ports:
      - protocol: tcp
        port: 80
      - protocol: tcp
        port: 443
    - cidr: 10.2.1.22/32
      ports:
      - protocol: tcp
        port: 80
      - protocol: tcp
        port: 443
    # Restbase
    - cidr: 10.2.1.17/32
      ports:
      - protocol: tcp
        port: 7231
      - protocol: tcp
        port: 7443
    - cidr: 10.2.2.17/32
      ports:
      - protocol: tcp
        port: 7231
      - protocol: tcp
        port: 7443
    # eventgate-main
    - cidr: 10.2.1.45/32
      ports:
        - protocol: tcp
          port: 4492
    - cidr: 10.2.2.45/32
      ports:
        - protocol: tcp
          port: 4492
