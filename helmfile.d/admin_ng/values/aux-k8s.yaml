# cluster_group is used to identify a group of similar clusters (like for one in eqiad and one in codfw)
# that share some config (values) in "admin_ng/values/<cluster_group>.yaml"
cluster_group: 'aux-k8s'

# Defaults applied to all aux-k8s clusters
GlobalNetworkPolicies:
  # Allow ICMP for all pods and all directions. Useful in debugging
  allow-all-icmp:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - 'Ingress'
      - 'Egress'
    ingress:
      - action: 'Allow'
        protocol: 'ICMP'
      - action: 'Allow'
        protocol: 'ICMPv6'
    egress:
      - action: 'Allow'
        protocol: 'ICMP'
      - action: 'Allow'
        protocol: 'ICMPv6'
  default-deny:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - 'Ingress'
      - 'Egress'
    egress:
      # Allow all namespaces to communicate to DNS pods
      - action: 'Allow'
        protocol: 'UDP'
        destination:
          selector: 'k8s-app == "kube-dns"'
          ports:
            - 53
  # This allows egress from all pods to all pods. Ingress still needs to be allowed by the destination, though.
  allow-pod-to-pod:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - 'Egress'
    egress:
      - action: 'Allow'
        destination:
          nets:
            # eqiad IPv4
            - '10.67.24.0/21'
      - action: 'Allow'
        destination:
          nets:
            # eqiad IPv6
            - '2620:0:861:302::/64'

# List all namespaces that should be created in every aux-k8s cluster.
# For info about what overrides are available, please check ./common.yaml.
namespaces:
  kube-system:
    systemNamespace: true
    allowCriticalPods: true
    pspClusterRole: 'allow-privileged-psp'
    labels:
      istio-injection: 'disabled'
  istio-system:
    systemNamespace: true
    allowCriticalPods: true
    labels:
      istio-injection: 'disabled'
  cert-manager:
    systemNamespace: true
    allowCriticalPods: true
    labels:
      istio-injection: 'disabled'

net_istio:
  ingressgateway:
    servers:
    # The 'hosts' field correspond to the list of backend routes that
    # Knative/Istio will allow/configure on the Gateway. For example,
    # if the FQDN for a Kfserving backend is something-test.example.com,
    # we can allow it in multiple ways:
    # 1) More specific: 'something-test.example.com'
    # 2) Less specific: '*.example.com'
    # 3) All traffic allowed: '*'
    # For the moment option (3) is fine, but we'll need to review the choice.
    - hosts:
        - '*'
      port:
        name: 'https'
        number: 443
        protocol: 'HTTPS'
      tls:
        mode: SIMPLE
        minProtocolVersion: 'TLSV1_2'
        # Please note:
        # This corresponds to the name of a TLS Secret deployed
        # to the istio-system namespace. We deploy it via
        # helmfile_namespace_certs.yaml.
        credentialName: 'knative-serving-tls-certificate'

# Istio Gateway config: The list of ports need to be kept in sync with what
# stated in the related custom_deploy.d's istioctl config.
istio:
  gateways:
    ingressgateway:
      ports:
        - 8443
    cluster-local-gateway:
      ports:
        - 8080
