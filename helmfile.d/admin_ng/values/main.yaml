# cluster_group is used to identify a group of similar clusters (like for one in eqiad and one in codfw)
# that share some config (values) in "admin_ng/values/<cluster_group>.yaml"
cluster_group: main

# List all namespaces that should be created in every ServiceOps cluster
# Some overrides are possible:
# <namespace-name>:
#   readOnlyUser: string
#     Default: <namepace-name>
#     The name of the read-only user for this namespace (needs to be created via private puppet).
#   deployUser: string
#     Default: <namepace-name>-deploy
#     The name of the deploy user for this namespace (needs to be created via private puppet).
#   tillerClusterRole: string
#     Default: tiller
#     ClusterRole to bind the tiller ServiceAccount to.
#   deployClusterRole: string
#     Default: deploy
#     ClusterRole to bind the deploy user to.
#   tiller_resources: {}
#     Default: {}
#     Provide a resource block for the tiller pod in this namespace to use.
#   pspClusterRole: string
#     Default: allow-restricted-psp
#     The name of the ClusterRole granting access to the PSP this namespace will use.
#     Note: If the ClusterRoleBinding already exists in the namespace, it will need to be deleted first and then recreated with the new ClusterRole
#   systemNamespace: bool
#     Default: false
#     Don't deploy users, tiller or resource quota into this namespace.
#     Kubernetes builtin namespaces (default, kube-.*) are always treated as system namespaces for safety reasons.
#   allowCriticalPods: bool
#     Default: false
#     Critical pods in this context are pods with priorityClassName set to system-cluster-critical or system-node-critical.
#     See:
#     * https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/
#     * https://kubernetes.io/docs/concepts/policy/resource-quotas/#limit-priority-class-consumption-by-default
#

namespaces:
  kube-system:
    systemNamespace: true
    allowCriticalPods: true
    pspClusterRole: allow-privileged-psp
  istio-system:
    systemNamespace: true
    allowCriticalPods: true
  apertium: {}
  api-gateway: {}
  apple-search: {}
  blubberoid: {}
  changeprop: {}
  changeprop-jobqueue: {}
  citoid: {}
  cxserver: {}
  echostore: {}
  eventgate-analytics: {}
  eventgate-analytics-external: {}
  eventgate-logging-external: {}
  eventgate-main: {}
  eventstreams: {}
  eventstreams-internal: {}
  linkrecommendation: {}
  mathoid: {}
  miscweb: {}
  mobileapps: {}
  mwdebug:
    pspClusterRole: allow-mediawiki-psp
  proton: {}
  push-notifications: {}
  rdf-streaming-updater:
    tillerClusterRole: tiller-flink
    deployClusterRole: deploy-flink
  recommendation-api: {}
  sessionstore: {}
  shellbox: {}
  shellbox-constraints: {}
  shellbox-media: {}
  shellbox-syntaxhighlight: {}
  shellbox-timeline: {}
  similar-users: {}
  tegola-vector-tiles: {}
  termbox: {}
  toolhub: {}
  wikifeeds: {}
  zotero: {}

GlobalNetworkPolicies:
  # Allow icmp for all pods and all directions. Useful in debugging
  allow-all-icmp:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - Ingress
      - Egress
    ingress:
      - action: Allow
        protocol: ICMP
      - action: Allow
        protocol: ICMPv6
    egress:
      - action: Allow
        protocol: ICMP
      - action: Allow
        protocol: ICMPv6
  # Allow tillers to talk to the kubernetes API. Note that we aren't able
  # to select the "default" namespace where the service resides are it has no
  # selectable Endpoints (it does have Endpoints, but calico doesn't seem to be
  # able to select them as there are no pods powering those endpoints)
  kubernetes-api:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - Egress
    egress:
      - action: Allow
        protocol: TCP
        source:
          selector: 'name == "tiller"'
        destination:
          ports:
            - 443
            - 6443
  default-deny:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - Ingress
      - Egress
    egress:
      # Allow all namespaces to communicate to DNS pods
      - action: Allow
        protocol: UDP
        destination:
          selector: 'k8s-app == "kube-dns"'
          ports:
            - 53
  # This allows egress from all pods to all pods. Ingress still needs to be allowed by the destination, though.
  allow-pod-to-pod:
    namespaceSelector: 'has(projectcalico.org/name) && projectcalico.org/name != "kube-system"'
    types:
      - Egress
    egress:
      - action: Allow
        destination:
          nets:
            # eqiad
            - "10.64.64.0/21"
            # codfw
            - "10.192.64.0/21"
            # staging-eqiad
            - "10.64.75.0/24"
            # staging-codfw
            - "10.192.75.0/24"
      - action: Allow
        destination:
          nets:
            # eqiad
            - "2620:0:861:cabe::/64"
            # codfw
            - "2620:0:860:cabe::/64"
            # staging-eqiad
            - "2620:0:861:babe::/64"
            # staging-codfw
            - "2620:0:860:babe::/64"