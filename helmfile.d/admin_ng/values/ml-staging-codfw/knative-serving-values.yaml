# Reduce the replicas from what we set for production.
core:
  activator:
    replicaCount: 2
  webhook:
    replicaCount: 2

# Override for T353622
net_istio:
  mesh:
    service_entries:
      # This is a test for T353622
      # The goal is to enable a more "transparent"
      # proxy mesh config for the isvc pods.
      # The domains below, for the moment, will need
      # to be kept in sync with the correspondent Virtual Service
      # rule. Once/if this test will reach production, we'll be able
      # to have only one list (replicated everywhere with Yaml anchors
      # in ml-serve.yaml).
      # This list is needed to instruct the Istio sidecar that
      # HTTP connections related to these domains on port 80 shouldn't
      # be forwarded to their real upstreams, but handled via
      # the virtual service config.
      mediawiki-api-proxied-domains:
        # Override mediawiki-api-vs to mw-api-int-ro T362316
        spec:
          hosts:
          - '*.wikipedia.org'
          - 'wikipedia.org'
          - '*.wiktionary.org'
          - 'wiktionary.org'
          - '*.wikidata.org'
          - 'wikidata.org'
          - '*.wikiquote.org'
          - 'wikiquote.org'
          - '*.wikibooks.org'
          - 'wikibooks.org'
          - '*.wikisource.org'
          - 'wikisource.org'
          ports:
          - name: http-port-k8s
            number: 4680
            protocol: HTTP
          - name: http-port
            number: 80
            protocol: HTTP
          resolution: NONE
    virtual_services:
      # Override mediawiki-api-vs to mw-api-int-ro T362316
      mediawiki-api-vs:
        spec:
          gateways:
          - mesh
          hosts:
          - '*.wikipedia.org'
          - 'wikipedia.org'
          - '*.wiktionary.org'
          - 'wiktionary.org'
          - '*.wikidata.org'
          - 'wikidata.org'
          - '*.wikiquote.org'
          - 'wikiquote.org'
          - '*.wikibooks.org'
          - 'wikibooks.org'
          - '*.wikisource.org'
          - 'wikisource.org'
          http:
          - match:
            - port: 4680
            route:
            - destination:
                host: mw-api-int-ro.discovery.wmnet
            retries:
              # Rationale (may need to be revisited after upgrading Istio):
              # https://phabricator.wikimedia.org/T320374#8338627
              attempts: 3
              retryOn: connect-failure,refused-stream,reset,503
            headers:
              request:
                set:
                  # The TLS egress origination settings (see the related destination
                  # rule's comment) have the side effect of presenting
                  # a 'x-forwarded-proto: http' header to the target API, that in turn
                  # may return a warning in every response. To circumvent this problem,
                  # let's explicitly set the header.
                  x-forwarded-proto: https
