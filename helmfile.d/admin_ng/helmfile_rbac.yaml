releases:
  - name: rbac-rules
    chart: wmf-stable/raw
    namespace: kube-system
    values:
      - resources:
        # ClusterRoles
        ## Aggregates additional permission to view ClusterRole, not used directly
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: view-additions
            labels:
              # Add these permissions to the "view" default role.
              rbac.authorization.k8s.io/aggregate-to-view: "true"
          rules:
            - apiGroups: [""]
              resources: ["pods/portforward"]
              verbs: ["create"]
            {{- if hasKey .Environment.Values "istio_gateways" }}
            - apiGroups: ["networking.istio.io"]
              resources: ["gateways", "virtualservices", "destinationrules"]
              verbs: ["get", "list", "watch"]
            {{- end }}
            {{- if hasKey .Environment.Values "install_cert_manager" }}
            - apiGroups: ["cert-manager.io"]
              resources: ["certificates"]
              verbs: ["get", "list", "watch"]
            {{- end }}
            {{- if hasKey .Environment.Values "install_flink_operator" }}
            - apiGroups: ["flink.apache.org"]
              resources: ["flinkdeployments"]
              verbs: ["get", "list", "watch"]
            {{- end }}
            {{- if hasKey .Environment.Values "install_kserve" }}
            - apiGroups: ["serving.kserve.io"]
              resources: ["*"]
              verbs: ["get", "list", "watch"]
            {{- end }}
      {{- if semverCompare .Values.kubernetesVersion "1.16" }}
        ## Used by prometheus in k8s 1.16 and before
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: api-metrics
          rules:
            - nonResourceURLs:
                - /metrics
              verbs: ["get"]
      {{- else }}
        ## Post 1.23 we use the default system:monitoring for access to
        # /metrics. However, this isn't enough and we also need a ClusterRole to
        # allow listing/getting/watching various cluster resources
        # NOTE: Upstream, at https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/rbac.md
        # has the following differences:
        # * List on nodes/metrics,which is covered by system:monitoring in our case
        # * Get on all configmaps, (to manage to start), we don't need that
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: prometheus
          rules:
          - apiGroups: [""]
            resources:
            - nodes
            - services
            - endpoints
            - pods
            verbs: ["get", "list", "watch"]
          - apiGroups:
            - networking.k8s.io
            resources:
            - ingresses
            verbs: ["get", "list", "watch"]
      {{- end }}
        ## Used by imagecatalog
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: imagecatalog
          rules:
            - apiGroups: [""]
              resources: ["namespaces", "pods"]
              verbs: ["list", "get"]
        ## Used by deploy users
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: deploy
          rules:
            - apiGroups: ["", "extensions", "apps", "networking.k8s.io", "batch"]
              resources: ["*"]
              verbs: ["*"]
            {{- if hasKey .Environment.Values "istio_gateways" }}
            - apiGroups: ["networking.istio.io"]
              resources: ["gateways", "virtualservices", "destinationrules"]
              verbs: ["*"]
            {{- end }}
            {{- if hasKey .Environment.Values "install_cert_manager" }}
            - apiGroups: ["cert-manager.io"]
              resources: ["certificates"]
              verbs: ["*"]
            {{- end }}
            {{- if hasKey .Environment.Values "install_flink_operator" }}
            - apiGroups: ["flink.apache.org"]
              resources: ["flinkdeployments"]
              verbs: ["*"]
            {{- end }}
      {{- range .Environment.Values.deployExtraClusterRoles }}
      {{- if eq . "flink" }}
        ## Used by deploy users
        ## Flink deploy users need permissions to add roles and role bindings
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: deploy-flink
          rules:
            - apiGroups: ["", "extensions", "apps", "networking.k8s.io", "batch"]
              resources: ["*"]
              verbs: ["*"]
            - apiGroups: ["rbac.authorization.k8s.io"]
              resources: ["roles", "rolebindings"]
              verbs: ["*"]
            - apiGroups: ["networking.istio.io"]
              resources: ["gateways", "virtualservices", "destinationrules"]
              verbs: ["*"]
            - apiGroups: ["cert-manager.io"]
              resources: ["certificates"]
              verbs: ["*"]
      {{- end }}
      {{- if eq . "kserve" }}
        ## Used by deploy users
        ## Kubeflow Kfserving/Kserve deploy users need extra permissions.
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: deploy-kserve
          rules:
            - apiGroups: ["", "extensions", "apps", "networking.k8s.io", "batch"]
              resources: ["*"]
              verbs: ["*"]
            - apiGroups: ["serving.kserve.io"]
              resources: ["inferenceservices"]
              verbs: ["*"]
      {{- end }}
      {{- if eq . "sparkapplications" }}
        ## Used by deploy users
        ## Spark deploy users need to be able to create SparkApplication and
        ## ScheduledSparkApplication objects in the spark namespace.
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: deploy-sparkapplications
          rules:
            - apiGroups: ["sparkoperator.k8s.io"]
              resources: ["sparkapplications", "scheduledsparkapplications"]
              verbs: ["*"]
            - apiGroups: ["sparkoperator.k8s.io"]
              resources: ["sparkapplications/status", "scheduledsparkapplications/status"]
              verbs: ["get"]
      {{- end }}
      {{- end }}
      {{- if semverCompare .Values.kubernetesVersion "1.16" }}
        # ClusterRoleBindings
        ## wmf-node-authorization adds the kubelet users group ("system:nodes")
        ## to the system:node ClusterRole so that the kubelet's can register nodes
        ## with the API. See:
        ## https://kubernetes.io/docs/reference/access-authn-authz/node/#migration-considerations
        ##
        ## This is only required for clusters running k8s 1.16. Starting with 1.23 we have
        ## the node authorizer enabled.
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: wmf-node-authorization
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:node
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: Group
              name: system:nodes
      {{- end }}
        ## Used by prometheus and rsyslog
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: view
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: view
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: Group
              name: view
      {{- if semverCompare .Values.kubernetesVersion "1.16" }}
        ## Used by prometheus in k8s 1.16, with 1.23 we use the default system:monitoring
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: api-metrics
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: api-metrics
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: Group
              name: api-metrics
        ## Used by prometheus in k8s 1.16, with 1.23 we use the default system:monitoring
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: api-metrics-heapster
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:heapster
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: Group
              name: api-metrics
      {{- else }}
        ## Used by prometheus in k8s 1.23
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: prometheus
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: prometheus
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: User
              name: prometheus
      {{- end }}
        ## Used by imagecatalog
        - apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: imagecatalog
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: imagecatalog
          subjects:
            - apiGroup: rbac.authorization.k8s.io
              kind: User
              name: imagecatalog
