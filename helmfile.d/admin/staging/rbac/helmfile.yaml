helmDefaults:
  tillerNamespace: kube-system  #dedicated default key for tiller-namespace
  tillerless: false                  #dedicated default key for tillerless
  # defaults for verify, wait, force, timeout and recreatePods under releases[]
  verify: false
  wait: true
  timeout: 600
  recreatePods: false
  force: false

releases:
  - name: rbac-deploy-clusterrole
    chart: stable/raw
    namespace: kube-system
    values:
      - templates:
        - |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: deploy
            labels:
              # Add these permissions to the "view" default role.
              rbac.authorization.k8s.io/aggregate-to-view: "true"
          rules: []
        - |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: api-metrics
          rules:
          - nonResourceURLs:
            - /metrics
            verbs: ["get"]
        - |
          # Used by rsyslog
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: view
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: view
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: view
        - |
          # Used by prometheus
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: api-metrics
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: api-metrics
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: api-metrics
    hooks:
    - events: ["prepare"]
      command: "helmfile_log_sal"
      args: [ "{{`{{.HelmfileCommand}}`}}", "[STAGING] Ran '{{`{{.HelmfileCommand}}`}}' command on namespace '{{`{{.Release.Namespace}}`}}' for release '{{`{{.Release.Name}}`}}' ."]
