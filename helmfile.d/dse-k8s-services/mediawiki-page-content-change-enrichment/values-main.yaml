# WMF production main release specific values.
#
# These are kept out of the primary values.yaml just so that it is easier to use
# with local development.
#
# Settings in this file should apply for all WMF production k8s clusters & enviroments.
# cluster/environment specific settings belong in env specific values files.

app:

  config_files:
    # Will be rendered into /srv/conf/app.config.yaml by flink-app chart.
    app.config.yaml:

      # Configs for the page_content_change enrichment job.
      enrich:
        mediawiki_api_endpoint_template: https://api-ro.discovery.wmnet/w/api.php
        ssl_ca_bundle_path: /etc/ssl/certs/ca-certificates.crt

      # Configs for eventutilities python stream_manager.
      stream_manager:
        job_name: mediawiki_page_content_change_enrich
        # Configure sources and sinks.
        # NOTE: Make sure to set kafka options in environment specific values files.
        source:
          stream: rc1.mediawiki.page_change:1.0.0
          connector: kafka

        sink:
          stream: rc1.mediawiki.page_content_change:1.0.0
          connector: kafka

        # Setting error to a string causes it to be used as the stream name.
        # Other sink settings will be copied from sink.
        error_sink: rc1.mediawiki_page_content_change_enrich.error

        # Load event schemas from local path baked into the image.
        schema_uris:
          - file:///srv/app/event-schemas/primary/jsonschema
        # Get stream config from MW EventStreamConfig API.
        stream_config_uri: https://meta.wikimedia.org/w/api.php

        # Production requests to stream_config_uri should
        # be routed via app-ro.discovery.wmnet
        http_client_routes:
          "https://meta.wikimedia.org/w/api.php": "https://api-ro.discovery.wmnet"


  flinkConfiguration:
    # The total memory available to the jobmanager and
    # taskmanager processes. This is the sum of on / off JVM heap memory,
    # JVM metaspace and JVM overhead.
    #
    # On containerized setups this should match the memory allocated to the
    # container.
    # See https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/config/#taskmanager-memory-process-size
    "jobmanager.memory.process.size": "1500m"
    "taskmanager.memory.process.size": "1500m"

  # TODO: might require tuning.
  # 1500m is the basline memory allocation used with the
  # YARN deployment of this job.
  jobManager:
    resource:
      memory: 1500m

  taskManager:
    resource:
      memory: 1500m

mesh:
  enabled: false

networkpolicy:
  egress:
    enabled: true
    dst_nets:
      # Allow api-ro
      - cidr: 10.2.2.22/32
        ports:
          - protocol: tcp
            port: 443
      - cidr: 10.2.1.22/32
        ports:
          - protocol: tcp
            port: 443
