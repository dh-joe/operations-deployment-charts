docker:
  registry: docker-registry.discovery.wmnet

app:
  version: &base-image-version 2024-11-07-160455-81db4193e50e13cf1835c694e21fb3273b3f7cc1@sha256:4349e884d17ab6303d9eb6ecf455a4fce3bcd65df83463a29934ad32988511bc
  executor_pod_image_version: *base-image-version

service:
  deployment: production

config:
  airflow:
    dbHost: 'an-db1001.eqiad.wmnet'
    config:
      datahub:
        cluster: prod
        conn_id: datahub_gms_prod
        enabled: true
  connections:
    s3_dpe:
      extra:
        endpoint_url: https://rgw.eqiad.dpe.anycast.wmnet
        region_name: dpe
    datahub_gms_prod:
      conn_type: datahub-rest
      host: http://datahub-gms-production.datahub.svc:8080
  oidc:
    idp_server: idp.wikimedia.org

external_services:
  gitlab: [wikimedia]
  wikimail: [mx]
  kerberos: [kdc]
  cas: [idp]
  s3: [eqiad-dpe]
  hive: [analytics]
  hadoop-master: [analytics]
  hadoop-worker: [analytics]

gitsync:
  image_tag: 2024-08-22-120818-fbafbcdb385bf1008ba0ac8ee350e9fe411a057d@sha256:3e01121704b405a08649012571aba0ce6834ab3aa3428df0b02a476b7ba4c3f5
  volume:
    storage_class: ceph-cephfs-ssd

kerberos:
  volume:
    storage_class: ceph-cephfs-ssd

worker:
  config:
    hadoop:
      hdfs:
        dfs.cluster.administrators: hdfs analytics-admins,ops
        dfs.ha.namenodes.analytics-hadoop: an-master1003-eqiad-wmnet,an-master1004-eqiad-wmnet
        dfs.hosts.exclude: /etc/hadoop/conf.analytics-hadoop/hosts.exclude
        dfs.internal.nameservices: analytics-hadoop
        dfs.namenode.http-address.analytics-hadoop.an-master1003-eqiad-wmnet: an-master1003.eqiad.wmnet:50070
        dfs.namenode.http-address.analytics-hadoop.an-master1004-eqiad-wmnet: an-master1004.eqiad.wmnet:50070
        dfs.namenode.rpc-address.analytics-hadoop.an-master1003-eqiad-wmnet: an-master1003.eqiad.wmnet:8020
        dfs.namenode.rpc-address.analytics-hadoop.an-master1004-eqiad-wmnet: an-master1004.eqiad.wmnet:8020
        dfs.namenode.servicerpc-address.analytics-hadoop.an-master1003-eqiad-wmnet: an-master1003.eqiad.wmnet:8040
        dfs.namenode.servicerpc-address.analytics-hadoop.an-master1004-eqiad-wmnet: an-master1004.eqiad.wmnet:8040
        dfs.namenode.shared.edits.dir: qjournal://an-worker1078.eqiad.wmnet:8485;an-worker1080.eqiad.wmnet:8485;an-worker1090.eqiad.wmnet:8485;an-worker1142.eqiad.wmnet:8485;analytics1072.eqiad.wmnet:8485/analytics-hadoop
        dfs.nameservices: analytics-hadoop
      core:
        fs.defaultFS: hdfs://analytics-hadoop/
        ha.zookeeper.quorum: an-conf1001.eqiad.wmnet,an-conf1002.eqiad.wmnet,an-conf1003.eqiad.wmnet
      yarn:
        yarn.node-labels.fs-store.root-dir: hdfs://analytics-hadoop/user/yarn/node-labels
        yarn.resourcemanager.cluster-id: analytics-hadoop
        yarn.resourcemanager.ha.rm-ids: an-master1003-eqiad-wmnet,an-master1004-eqiad-wmnet
        yarn.resourcemanager.hostname.an-master1003-eqiad-wmnet: an-master1003.eqiad.wmnet
        yarn.resourcemanager.hostname.an-master1004-eqiad-wmnet: an-master1004.eqiad.wmnet
        yarn.resourcemanager.keytab: /etc/security/keytabs/hadoop/yarn.keytab
        yarn.resourcemanager.webapp.address.an-master1003-eqiad-wmnet: an-master1003.eqiad.wmnet:8088
        yarn.resourcemanager.webapp.address.an-master1004-eqiad-wmnet: an-master1004.eqiad.wmnet:8088
        yarn.resourcemanager.zk-address: an-conf1001.eqiad.wmnet,an-conf1002.eqiad.wmnet,an-conf1003.eqiad.wmnet
    spark:
      spark:
        spark.executorEnv.REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
        spark.yarn.appMasterEnv.REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
        spark.yarn.historyServer.address: yarn.wikimedia.org
      hive:
        hive.metastore.kerberos.keytab.file: /etc/security/keytabs/hive/hive.keytab
        hive.metastore.kerberos.principal: hive/analytics-hive.eqiad.wmnet@WIKIMEDIA
        hive.metastore.uris: thrift://analytics-hive.eqiad.wmnet:9083
        hive.server2.authentication.kerberos.keytab: /etc/security/keytabs/hive/hive.keytab
        hive.server2.authentication.kerberos.principal: hive/analytics-hive.eqiad.wmnet@WIKIMEDIA

# We hardcode this hostname / ip mapping to allow Hadoop to perform a reverse DNS
# resolution of the IPs and to get these hostnames, instead of the coreDNS reverse
# service IP PTR entries, to make it validate the Kerberos service name.
# See https://phabricator.wikimedia.org/T377602#10295542
host_aliases:
  an-master1003.eqiad.wmnet: 10.64.36.15
  an-master1004.eqiad.wmnet: 10.64.53.14
